name: Coverage Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  coverage-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install PHP dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Install Node.js dependencies
        run: npm ci
      
      - name: Create environment file
        run: |
          cp .env.ci .env
          php artisan key:generate
      
      - name: Build frontend assets
        run: npm run build
      
      - name: Configure database
        run: |
          php artisan config:cache
          php artisan migrate --force
      
      - name: Run tests with coverage
        run: composer test:coverage
      
      - name: Generate coverage summary
        id: coverage
        run: |
          if [ -f coverage-clover.xml ]; then
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage-clover.xml');
              \$metrics = \$xml->project->metrics;
              \$elements = (int)\$metrics['elements'];
              \$coveredelements = (int)\$metrics['coveredelements'];
              \$coverage = \$elements > 0 ? round((\$coveredelements / \$elements) * 100, 2) : 0;
              echo \$coverage;
            ")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸: $COVERAGE%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage-html/
            coverage-clover.xml
          retention-days: 30
      
      - name: Comment coverage on PR
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const coverageIcon = coverage >= 80 ? 'ğŸŸ¢' : coverage >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
            const body = `## ${coverageIcon} ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
            
            **ã‚«ãƒãƒ¬ãƒƒã‚¸: ${coverage}%**
            
            ${coverage >= 80 ? 'âœ… å„ªç§€ãªã‚«ãƒãƒ¬ãƒƒã‚¸ã§ã™ï¼' : 
              coverage >= 60 ? 'âš ï¸  ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ”¹å–„ã‚’æ¤œè¨ã—ã¦ãã ã•ã„' : 
              'âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ã„ã§ã™ã€‚ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚’ãŠå‹§ã‚ã—ã¾ã™'}
            
            ğŸ“Š è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯[Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ãã¾ã™ã€‚
            `;
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }