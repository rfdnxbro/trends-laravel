name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹

on:
  push:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: coverage-pages
  cancel-in-progress: false

jobs:
  coverage-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: PHPä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        run: |
          cp .env.ci .env
          php artisan key:generate --force
      
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build
      
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¨­å®š
        run: |
          php artisan config:cache
          php artisan migrate --force
      
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: |
          php artisan test --coverage-html=public/coverage --coverage-clover=public/coverage.xml
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’JSONã§ç”Ÿæˆ
          COVERAGE=$(php artisan test --coverage-text | grep "Lines:" | grep -oE '[0-9]+\.[0-9]+' | head -n1)
          METHODS=$(php artisan test --coverage-text | grep "Methods:" | grep -oE '[0-9]+\.[0-9]+' | head -n1)
          CLASSES=$(php artisan test --coverage-text | grep "Classes:" | grep -oE '[0-9]+\.[0-9]+' | head -n1)
          
          # ãƒãƒƒã‚¸ã¨ã‚µãƒãƒªãƒ¼ç”¨ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > public/coverage-summary.json << EOF
          {
            "lines": ${COVERAGE:-0},
            "methods": ${METHODS:-0},
            "classes": ${CLASSES:-0},
            "generated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF
          
          # ã‚·ãƒ³ãƒ—ãƒ«ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰HTMLä½œæˆ
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ - Trends Laravel</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  .header { text-align: center; margin-bottom: 30px; }
                  .badge { display: inline-block; padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
                  .badge.high { background: #28a745; }
                  .badge.medium { background: #ffc107; color: #212529; }
                  .badge.low { background: #dc3545; }
                  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                  .metric { padding: 20px; background: #f8f9fa; border-radius: 6px; text-align: center; }
                  .metric-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
                  .metric-label { color: #666; font-size: 0.9em; }
                  .links { margin-top: 30px; text-align: center; }
                  .links a { display: inline-block; margin: 0 10px; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
                  .links a:hover { background: #0056b3; }
                  .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9em; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ</h1>
                      <p>Trends Laravel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
                  </div>
                  
                  <div class="metrics" id="metrics">
                      <!-- ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                  </div>
                  
                  <div class="links">
                      <a href="./coverage/index.html">ğŸ“Š è©³ç´°ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ</a>
                      <a href="./coverage.xml">ğŸ“„ XMLãƒ¬ãƒãƒ¼ãƒˆ</a>
                      <a href="https://github.com/rfdnxbro/trends-laravel">ğŸ“š GitHubãƒªãƒã‚¸ãƒˆãƒª</a>
                  </div>
                  
                  <div class="footer">
                      <p id="generated-time">ç”Ÿæˆæ—¥æ™‚: èª­ã¿è¾¼ã¿ä¸­...</p>
                      <p>ğŸ¤– Generated with Claude Code</p>
                  </div>
              </div>
              
              <script>
                  // ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
                  fetch('./coverage-summary.json')
                      .then(response => response.json())
                      .then(data => {
                          const metrics = document.getElementById('metrics');
                          
                          function getBadgeClass(value) {
                              if (value >= 95) return 'high';
                              if (value >= 80) return 'medium';
                              return 'low';
                          }
                          
                          metrics.innerHTML = `
                              <div class="metric">
                                  <div class="metric-value">
                                      <span class="badge ${getBadgeClass(data.lines)}">${data.lines}%</span>
                                  </div>
                                  <div class="metric-label">ãƒ©ã‚¤ãƒ³ ã‚«ãƒãƒ¬ãƒƒã‚¸</div>
                              </div>
                              <div class="metric">
                                  <div class="metric-value">
                                      <span class="badge ${getBadgeClass(data.methods)}">${data.methods}%</span>
                                  </div>
                                  <div class="metric-label">ãƒ¡ã‚½ãƒƒãƒ‰ ã‚«ãƒãƒ¬ãƒƒã‚¸</div>
                              </div>
                              <div class="metric">
                                  <div class="metric-value">
                                      <span class="badge ${getBadgeClass(data.classes)}">${data.classes}%</span>
                                  </div>
                                  <div class="metric-label">ã‚¯ãƒ©ã‚¹ ã‚«ãƒãƒ¬ãƒƒã‚¸</div>
                              </div>
                          `;
                          
                          document.getElementById('generated-time').textContent = 
                              `ç”Ÿæˆæ—¥æ™‚: ${new Date(data.generated).toLocaleString('ja-JP')} (${data.branch}ãƒ–ãƒ©ãƒ³ãƒ)`;
                      })
                      .catch(error => {
                          console.error('ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                          document.getElementById('metrics').innerHTML = 
                              '<p style="text-align: center; color: #dc3545;">ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                      });
              </script>
          </body>
          </html>
          EOF
      
      - name: GitHub Pagesã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/configure-pages@v4
      
      - name: GitHub Pagesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
      
      - name: GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4