name: カバレッジチェック

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    strategy:
      fail-fast: false
    
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4
      
      - name: PHPセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: Node.jsセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Composer依存関係をキャッシュ
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: PHP依存関係をインストール
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Node.js依存関係をインストール
        run: npm ci
      
      - name: 環境ファイルを作成
        run: |
          cp .env.ci .env
          php artisan key:generate --force
      
      - name: フロントエンドアセットをビルド
        run: npm run build
      
      - name: データベースを設定
        run: |
          php artisan config:cache
          php artisan migrate --force
      
      - name: カバレッジ付きテストを実行
        run: php artisan test --coverage-html=coverage-html --coverage-clover=coverage-clover.xml --stop-on-failure
      
      - name: カバレッジサマリーを生成と95%閾値チェック
        id: coverage
        run: |
          if [ -f coverage-clover.xml ]; then
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage-clover.xml');
              \$metrics = \$xml->project->metrics;
              \$elements = (int)\$metrics['elements'];
              \$coveredelements = (int)\$metrics['coveredelements'];
              \$coverage = \$elements > 0 ? round((\$coveredelements / \$elements) * 100, 2) : 0;
              echo \$coverage;
            ")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "📈 現在のテストカバレッジ: $COVERAGE%"
            
            # 95%閾値チェック
            if (( $(echo "$COVERAGE < 95.0" | bc -l) )); then
              echo "❌ テストカバレッジが95%を下回っています: ${COVERAGE}%"
              echo "📚 カバレッジ改善領域:"
              echo "   - Console Commands: handleメソッドテスト実装"
              echo "   - API Controllers: メソッドテスト完全実装"
              echo "   - Scraping Services: 未テストメソッド実装"
              echo "   - Resources & Models: 未カバー箇所完全実装"
              echo "💡 カバレッジ向上のため、該当領域のテスト実装をお願いします。"
              exit 1
            fi
            
            echo "✅ テストカバレッジチェック合格: ${COVERAGE}%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "❌ カバレッジファイルが見つかりません"
            exit 1
          fi
      
      - name: カバレッジレポートをアーティファクトにアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage-html/
            coverage-clover.xml
          retention-days: 30
      
      - name: PRにカバレッジをコメント
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || '0';
            const coverageIcon = coverage >= 95 ? '🟢' : coverage >= 80 ? '🟡' : '🔴';
            const thresholdStatus = coverage >= 95 ? '✅ 95%閾値達成' : '❌ 95%閾値未達成';
            
            const body = `## ${coverageIcon} テストカバレッジレポート
            
            **カバレッジ: ${coverage}% | ${thresholdStatus}**
            
            ${coverage >= 95 ? '✅ 優秀なカバレッジです！95%閾値を達成しています。' : 
              coverage >= 80 ? '⚠️  95%閾値未達成です。カバレッジの改善をお願いします。' : 
              '❌ カバレッジが大幅に不足しています。テストの追加が必要です。'}
            
            📊 詳細なレポートは[Artifactsからダウンロード](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})できます。
            
            ${coverage < 95 ? `
            ### 📚 カバレッジ改善領域
            - **Console Commands**: handleメソッドテスト実装
            - **API Controllers**: メソッドテスト完全実装  
            - **Scraping Services**: 未テストメソッド実装
            - **Resources & Models**: 未カバー箇所完全実装
            ` : ''}
            `;
            
            // 既存のコメントを探す
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('テストカバレッジレポート')
            );
            
            if (botComment) {
              // 既存のコメントを更新
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // 新しいコメントを作成
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }