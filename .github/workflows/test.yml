name: å“è³ªãƒã‚§ãƒƒã‚¯

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # å…±é€šã®ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Composerä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: node_modulesã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: PHPä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        run: |
          cp .env.ci .env
          php artisan key:generate --force
      
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            vendor/
            node_modules/
            public/build/
            bootstrap/cache/
            .env
            .env.ci
            storage/framework/cache/
          retention-days: 1

  # PHPãƒ†ã‚¹ãƒˆ
  php-tests:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: ç’°å¢ƒã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¨­å®š
        run: |
          # ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºå®Ÿã«è¨­å®š
          export DB_CONNECTION=sqlite
          export DB_DATABASE=":memory:"
          
          # è¨­å®šã®ã‚¯ãƒªã‚¢
          php artisan config:clear
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
          php artisan migrate --force
      
      - name: PHPãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: php artisan test --stop-on-failure
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ":memory:"

  # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
  code-style:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: vendor/bin/pint --test

  # é™çš„è§£æ
  static-analysis:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: é™çš„è§£æã‚’å®Ÿè¡Œ
        run: vendor/bin/phpstan analyse --no-progress --memory-limit=1G

  # PHPå¾ªç’°çš„è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯
  php-complexity:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: PHPå¾ªç’°çš„è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: |
          vendor/bin/phpmetrics --config=phpmetrics.json --report-html=phpmetrics-report app/
          echo "PHPMetrics report generated at phpmetrics-report/index.html"
      
      - name: PHPMetricsãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: phpmetrics-report
          path: phpmetrics-report/
          retention-days: 30

  # TypeScriptå“è³ªãƒã‚§ãƒƒã‚¯
  typescript-checks:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: TypeScriptå¾ªç’°çš„è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: npx eslint 'resources/js/**/*.{ts,tsx}' --max-warnings 0

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  frontend-tests:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: npm run test

  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆPRæ™‚ã®ã¿ï¼‰
  coverage:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'pull_request' && !contains(github.event.head_commit.message, '[skip ci]') }}
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: PHPã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
          coverage: xdebug
      
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: å®Ÿè¡Œæ¨©é™ã‚’ä¿®æ­£
        run: |
          chmod +x vendor/bin/*
      
      - name: ç’°å¢ƒã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¨­å®š
        run: |
          # ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºå®Ÿã«è¨­å®š
          export DB_CONNECTION=sqlite
          export DB_DATABASE=":memory:"
          
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰
          php artisan config:clear
          php artisan cache:clear
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
          php artisan migrate --force
      
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: php artisan test --coverage-html=coverage-html --coverage-clover=coverage-clover.xml --stop-on-failure
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ":memory:"
      
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã¨95%é–¾å€¤ãƒã‚§ãƒƒã‚¯
        id: coverage
        run: |
          if [ -f coverage-clover.xml ]; then
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage-clover.xml');
              \$metrics = \$xml->project->metrics;
              \$elements = (int)\$metrics['elements'];
              \$coveredelements = (int)\$metrics['coveredelements'];
              \$coverage = \$elements > 0 ? round((\$coveredelements / \$elements) * 100, 2) : 0;
              echo \$coverage;
            ")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ğŸ“ˆ ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: $COVERAGE%"
            
            # 95%é–¾å€¤ãƒã‚§ãƒƒã‚¯
            if (( $(echo "$COVERAGE < 95.0" | bc -l) )); then
              echo "âŒ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ95%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™: ${COVERAGE}%"
              echo "ğŸ’¡ ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šã®ãŸã‚ã€ãƒ†ã‚¹ãƒˆå®Ÿè£…ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"
              exit 1
            fi
            
            echo "âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯åˆæ ¼: ${COVERAGE}%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
      
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage-html/
            coverage-clover.xml
          retention-days: 30
      
      - name: PRã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || '0';
            const coverageIcon = coverage >= 95 ? 'ğŸŸ¢' : coverage >= 80 ? 'ğŸŸ¡' : 'ğŸ”´';
            const thresholdStatus = coverage >= 95 ? 'âœ… 95%é–¾å€¤é”æˆ' : 'âŒ 95%é–¾å€¤æœªé”æˆ';
            
            const body = `## ${coverageIcon} ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
            
            **ã‚«ãƒãƒ¬ãƒƒã‚¸: ${coverage}% | ${thresholdStatus}**
            
            ${coverage >= 95 ? 'âœ… å„ªç§€ãªã‚«ãƒãƒ¬ãƒƒã‚¸ã§ã™ï¼95%é–¾å€¤ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚' : 
              coverage >= 80 ? 'âš ï¸  95%é–¾å€¤æœªé”æˆã§ã™ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ”¹å–„ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚' : 
              'âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå¤§å¹…ã«ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã®è¿½åŠ ãŒå¿…è¦ã§ã™ã€‚'}
            
            ğŸ“Š è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯[Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ãã¾ã™ã€‚
            
            ${coverage < 95 ? `
            ### ğŸ’¡ ãƒ†ã‚¹ãƒˆæ”¹å–„ã®ãƒ’ãƒ³ãƒˆ
            è©³ç´°ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æœªã‚«ãƒãƒ¼ç®‡æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            ` : ''}
            `;
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¢ºèª
  all-checks:
    runs-on: ubuntu-latest
    needs: [php-tests, code-style, static-analysis, php-complexity, typescript-checks, frontend-tests]
    if: ${{ always() && !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã‹ç¢ºèª
        run: |
          if [[ "${{ needs.php-tests.result }}" != "success" || \
                "${{ needs.code-style.result }}" != "success" || \
                "${{ needs.static-analysis.result }}" != "success" || \
                "${{ needs.php-complexity.result }}" != "success" || \
                "${{ needs.typescript-checks.result }}" != "success" || \
                "${{ needs.frontend-tests.result }}" != "success" ]]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "All checks passed successfully!"