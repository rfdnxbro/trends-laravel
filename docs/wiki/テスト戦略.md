# テスト戦略

## テストピラミッドに基づく責務分離

このプロジェクトでは、効率的で保守性の高いテスト戦略として**テストピラミッド**を採用し、各テストレベルの責務を明確に分離しています。

### テストレベルと責務

```
           E2E Tests (少数・高価値)
          /                      \
     Feature Tests (適量・統合検証)
    /                              \
Unit Tests (多数・高速・詳細)
```

| テストレベル | 主要責務 | 検証対象 | 実行環境 |
|-------------|---------|----------|---------|
| **Unit Tests** | 個別コンポーネントのロジック | バリデーション、計算処理、ビジネスロジック | モック・スタブ使用 |
| **Feature Tests** | API統合・データフロー | HTTPエンドポイント、データベース連携、リクエスト/レスポンス | 実際のHTTP + DB |
| **E2E Tests** | ユーザージャーニー | 画面操作、ページ遷移、ワークフロー | ブラウザ自動化 |

## Unit Tests vs Feature Tests の使い分け指針

### ✅ Unit Tests を選択すべきケース
- **純粋なビジネスロジック**: 計算処理、データ変換、条件分岐
- **サービスクラスのメソッド**: 外部依存のない処理
- **ヘルパー関数**: ユーティリティ関数、フォーマッター
- **モデルのスコープ・アクセサ**: データベースアクセスを伴わない処理

**例：**
```php
// 循環的複雑度の計算ロジック
public function test_複雑度計算が正しく動作する()
{
    $service = new ComplexityCalculator();
    $result = $service->calculate($codeMetrics);
    $this->assertEquals(15, $result);
}
```

### ✅ Feature Tests を優先すべきケース
- **コントローラーのテスト**: HTTPリクエスト/レスポンスの検証
- **API エンドポイント**: ルーティング、ミドルウェア、認証を含む統合テスト
- **データベース操作を含む処理**: CRUD操作、トランザクション
- **複数コンポーネントの連携**: サービス間の統合動作

**例：**
```php
// API エンドポイントの統合テスト
public function test_企業作成APIが正常に動作する()
{
    $response = $this->postJson('/api/companies', $data);
    $response->assertStatus(201);
    $this->assertDatabaseHas('companies', ['name' => 'テスト企業']);
}
```

### ⚠️ 避けるべきアンチパターン
1. **メソッド存在確認テスト**: カバレッジに寄与しない
   ```php
   // ❌ 避けるべき
   public function test_メソッドが存在する()
   {
       $this->assertTrue(method_exists($controller, 'index'));
   }
   ```

2. **モックを使った重複テスト**: Feature テストで実際の動作を検証済みの場合
   ```php
   // ❌ 避けるべき（Feature テストで十分）
   public function test_モックを使ったコントローラーテスト()
   {
       $mock->shouldReceive('find')->once();
       // Feature テストで実際のDBアクセスを検証済み
   }
   ```

3. **文字列検索テスト**: 実装詳細に依存し、リファクタリングで壊れやすい
   ```php
   // ❌ 避けるべき
   public function test_コード内に特定の文字列が含まれる()
   {
       $this->assertStringContains('Cache::remember', $code);
   }
   ```

## テストの品質基準
- **境界値テスト**: 異常系・エッジケースの網羅
- **エラーハンドリング**: 各レベルで適切に検証
- **カバレッジ**: 95%以上を維持

## カバレッジ向上の戦略

### 効率的なカバレッジ改善アプローチ
1. **カバレッジレポートの活用**
   ```bash
   # HTMLレポートを生成して未カバー部分を可視化
   php artisan test --coverage-html=coverage-html
   # coverage-html/index.html をブラウザで開く
   ```

2. **優先順位付け**
   - **高**: コントローラー、サービスクラスの主要メソッド
   - **中**: モデルのビジネスロジック、バリデーション
   - **低**: getter/setter、単純なアクセサ

3. **Feature Tests による効率的カバレッジ向上**
   ```php
   // 1つのFeature Testで複数のコンポーネントをカバー
   public function test_企業詳細API全体フロー()
   {
       $company = Company::factory()->create();
       
       // Controller + Service + Model + Cache を一度にカバー
       $response = $this->getJson("/api/companies/{$company->id}");
       
       $response->assertStatus(200)
           ->assertJsonStructure(['data', 'meta']);
   }
   ```

4. **エッジケースの網羅**
   - 404エラー（存在しないリソース）
   - 422エラー（バリデーションエラー）
   - 409エラー（競合エラー）
   - 空のコレクション、null値の処理

## テストの最適化とメンテナンス

### 定期的なテストレビュー
1. **四半期ごとのテスト棚卸し**
   - カバレッジに寄与しないテストの削除
   - 重複テストの統合
   - 実装変更に追従していないテストの更新

2. **テスト実行時間の監視**
   ```bash
   # 遅いテストの特定
   php artisan test --profile
   ```

3. **テストの保守性向上**
   - テストデータはFactoryを活用
   - 共通のセットアップはtraitに抽出
   - アサーションは意図が明確になるよう記述

## E2Eテスト実装の必須要件

**新しいページや機能を実装する際は、以下のE2Eテストの実装が必須です：**

1. **新しいページの実装時**
   - ページの基本表示確認
   - 主要な操作フローの検証
   - レスポンシブデザインの動作確認
   - エラー状態の処理確認

2. **新しい機能の実装時**
   - 機能の基本動作確認
   - ユーザーインタラクションの検証
   - 関連ページとの遷移確認

3. **実装例**
   ```typescript
   // tests/e2e/new-feature.spec.ts
   test.describe('新機能ページ', () => {
     test('基本表示が正常に動作する', async ({ page }) => {
       // ページアクセス・表示確認
     });
     
     test('主要操作フローが動作する', async ({ page }) => {
       // ユーザー操作・結果確認
     });
   });
   ```

**E2Eテストなしでの新機能PR作成は禁止** - レビュー時に必ずチェックし、不足している場合は実装を求めてください。

### E2Eテストの実装詳細

E2Eテストには**Playwright**を使用し、実際のブラウザでユーザーの操作フローを検証します：

**📁 テストファイル構成**
詳細な構成は [tests/e2e/](../../tests/e2e/) を参照してください。

**実装済みE2Eテスト**
- `tests/e2e/homepage.spec.ts`: ホームページの基本機能テスト
- `tests/e2e/article-list.spec.ts`: 記事一覧ページの総合テスト（10テストケース）
- `tests/e2e/company-list.spec.ts`: 企業一覧ページの総合テスト（10テストケース）
- `tests/e2e/company-detail.spec.ts`: 企業詳細ページの総合テスト（12テストケース）

**🎯 E2Eテストの焦点**
- ✅ ページの基本表示（React アプリケーションのマウント）
- ✅ ナビゲーション要素の存在確認
- ✅ レスポンシブデザインの動作確認
- ✅ JavaScriptエラーの検出
- ✅ アプリケーション状態管理の確認

**🚀 E2Eテスト実行方法**
```bash
# 基本実行
npx playwright test

# ヘッドレスモードで実行（ブラウザ画面表示）
npx playwright test --headed

# 特定のテストのみ実行
npx playwright test tests/e2e/homepage.spec.ts

# テストレポート表示
npx playwright show-report
```

**⚡ 実行パフォーマンス**
- 実行時間: 約2分（13テスト）
- 並列実行: 4ワーカーで同時実行
- 対象ブラウザ: Chrome（Chromium）
- CI環境: PostgreSQL + Laravel開発サーバー
- MCP統合: Claude Codeでテスト自動化サポート

## テスト実装ガイドライン
- **基本方針**: 新機能追加時は対応するテストを必ず作成し、既存のカバレッジレベルを維持または向上させる
- **リファクタリング時**: コード変更後もテストカバレッジが低下しないよう、必要に応じてテストケースを追加
- **テスト削除時**: 冗長なテスト削除の際は、削除対象が本当に不要かを慎重に検討し、必要に応じて代替テストを実装
- **品質優先**: カバレッジ数値だけでなく、エッジケースや例外処理も含む包括的なテストを作成する

## 関連ドキュメント

- [開発フロー](開発フロー.md) - 開発プロセス全般