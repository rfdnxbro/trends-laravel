# 開発フロー

## 基本的な開発フロー

### 1. ブランチの作成

開発はブランチを切って作業する

```bash
# 新しいブランチを作成
git checkout -b feature/new-feature

# または
git switch -c feature/new-feature
```

### 2. 開発作業

- コードの実装
- テストの作成・実行
- コードスタイルチェック
- 静的解析の実行

#### モデル作成時の必須要件

新しいモデルを作成する際は、以下を必ず含める：

1. **Migration作成**
   - 適切なテーブル構造の定義
   - 必要なインデックスと制約の設定
   - コメントの追加

2. **モデルクラス作成**
   - `fillable`属性の設定
   - 適切な型キャスト（`casts`）の設定
   - デフォルト値の設定（必要に応じて）
   - リレーションの定義（必要に応じて）

3. **ユニットテスト作成**
   - 基本的なモデル作成テスト
   - 必須フィールドの検証テスト
   - UNIQUE制約等の制約テスト
   - デフォルト値の動作確認テスト
   - `fillable`属性の確認テスト
   - 型変換の確認テスト
   - タイムスタンプの確認テスト
   - リレーションのテスト（必要に応じて）

### 3. プルリクエストの作成

- 必ずプルリクエストを作成
- 適切なタイトルと説明を記述
- レビュアーを指定

### 4. コードレビュー

- 必ずプルリクエストのレビューを通す
- レビューでの指摘は修正する
- 承認後にmergeの準備が完了

### 5. マージ

- その後GitHub上でmergeを行う
- マージ後はローカルブランチを削除

## ブランチ命名規則

### 推奨命名パターン

```
feature/機能名      # 新機能追加
bugfix/バグ修正名   # バグ修正
hotfix/緊急修正名   # 緊急修正
refactor/リファクタ名 # リファクタリング
```

### 例

```
feature/user-authentication
bugfix/login-error
hotfix/security-patch
refactor/database-queries
```

## コミットメッセージ

### フォーマット

```
種類: 概要

詳細説明（必要に応じて）
```

### 種類の例

- `feat`: 新機能追加
- `fix`: バグ修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `docs`: ドキュメント更新

## 品質チェック

### ✅ 自動実行される品質チェック（CI/CD）

**PR作成時に自動実行されます：**

- PHPUnitテスト（223テスト）
- フロントエンドテスト（64テスト、vitest）
- Laravel Pintコードスタイルチェック
- PHPStan静的解析（レベル4、警告ゼロ）
- フロントエンドビルドテスト

### 開発中の手動チェック（推奨）

開発中に以下を実行することで、CI/CDでのエラーを事前に防げます：

1. **バックエンドテスト実行**
   ```bash
   php artisan test
   ```

2. **フロントエンドテスト実行**
   ```bash
   npm test
   ```

3. **コードスタイルチェック**
   ```bash
   vendor/bin/pint --test  # チェックのみ
   vendor/bin/pint         # 自動修正
   ```

4. **静的解析**
   ```bash
   vendor/bin/phpstan analyse --memory-limit=1G
   ```

5. **フロントエンドビルド**
   ```bash
   npm run build
   ```

### テストでの日本語化Fakerの使用

テストでは日本語のダミーデータを生成するため、Fakerの日本語化を行っています。

```php
// TestCase.php や各テストクラスで使用
$faker = \Faker\Factory::create('ja_JP');

// 例：日本語の会社名を生成
$companyName = $faker->company;
$personName = $faker->name;
$email = $faker->email;
$url = $faker->url;
```

**設定方法：**
1. `tests/TestCase.php`でFakerの日本語化設定を追加
2. 各テストクラスで`$this->faker()`メソッドを使用してアクセス

4. **スクレイピング機能テスト**
   ```bash
   # キューワーカーの起動確認
   php artisan queue:work --once
   
   # スクレイピングJobの手動実行
   php artisan tinker
   dispatch(new App\Jobs\HatenaScrapingJob());
   
   # Horizonでキューの状況確認
   php artisan horizon:status
   ```

## レビュー観点

### コードレビューで確認すべき点

- 機能要件の実現
- テストの妥当性
- コードスタイルの統一
- パフォーマンスの考慮
- セキュリティの確保
- 可読性・保守性
- **モデル関連の追加確認項目**
  - Migrationとモデルの整合性
  - 適切なfillable属性の設定
  - 型キャストの妥当性
  - テストカバレッジの十分性
  - 制約とバリデーションの適切性
- **スクレイピング関連の追加確認項目**
  - エラーハンドリングの実装
  - リトライ機能の設定
  - レート制限の考慮
  - 外部サイトの利用規約遵守
  - CompanyMatcherの適切な統合
  - 企業マッチング精度の検証

## wikiドキュメント更新の指示

### 更新タイミング
以下のような変更を行った際は、対応するwikiドキュメントの更新も検討してください：

#### 技術的変更
- 新しいライブラリ・パッケージ追加 → [技術スタック.md](技術スタック.md)
- 開発コマンド・環境設定変更 → [開発環境.md](開発環境.md)
- CI/CDワークフロー変更 → [CI-CD.md](CI-CD.md)

#### データベース変更
- migration追加・変更 → [データベース設計.md](データベース設計.md)
- モデル追加・変更 → [データベース設計.md](データベース設計.md)

#### 機能変更
- 新機能追加 → [機能仕様.md](機能仕様.md)
- 既存機能の大幅変更 → [機能仕様.md](機能仕様.md)

### 確認方法
変更後は以下を確認：
1. 実装とwikiドキュメントの内容に矛盾がないか
2. 新しい設定やコマンドがドキュメントに記載されているか
3. 古い情報が残っていないか

## 関連ドキュメント

- [開発環境](開発環境)
- [CI/CD](CI-CD)
- [技術スタック](技術スタック)
- [プロジェクト概要](プロジェクト概要)