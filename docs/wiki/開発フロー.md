# 開発フロー

## 基本的な開発フロー

### 1. ブランチの作成

開発はブランチを切って作業する

```bash
# 新しいブランチを作成
git checkout -b feature/new-feature

# または
git switch -c feature/new-feature
```

### 2. 開発作業

- コードの実装
- テストの作成・実行
- コードスタイルチェック
- 静的解析の実行

#### モデル作成時の必須要件

新しいモデルを作成する際は、以下を必ず含める：

1. **Migration作成**
   - 適切なテーブル構造の定義
   - 必要なインデックスと制約の設定
   - コメントの追加

2. **モデルクラス作成**
   - `fillable`属性の設定
   - 適切な型キャスト（`casts`）の設定
   - デフォルト値の設定（必要に応じて）
   - リレーションの定義（必要に応じて）

3. **ユニットテスト作成**
   - 基本的なモデル作成テスト
   - 必須フィールドの検証テスト
   - UNIQUE制約等の制約テスト
   - デフォルト値の動作確認テスト
   - `fillable`属性の確認テスト
   - 型変換の確認テスト
   - タイムスタンプの確認テスト
   - リレーションのテスト（必要に応じて）

### 3. プルリクエストの作成

- 必ずプルリクエストを作成
- 適切なタイトルと説明を記述
- レビュアーを指定

### 4. コードレビュー

- 必ずプルリクエストのレビューを通す
- レビューでの指摘は修正する
- 承認後にmergeの準備が完了

### 5. マージ

- その後GitHub上でmergeを行う
- マージ後はローカルブランチを削除

## ブランチ命名規則

### 推奨命名パターン

```
feature/機能名      # 新機能追加
bugfix/バグ修正名   # バグ修正
hotfix/緊急修正名   # 緊急修正
refactor/リファクタ名 # リファクタリング
```

### 例

```
feature/user-authentication
bugfix/login-error
hotfix/security-patch
refactor/database-queries
```

## コミットメッセージ

### フォーマット

```
種類: 概要

詳細説明（必要に応じて）
```

### 種類の例

- `feat`: 新機能追加
- `fix`: バグ修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `docs`: ドキュメント更新

## テスト戦略

### テストピラミッドに基づく責務分離

このプロジェクトでは、効率的で保守性の高いテスト戦略として**テストピラミッド**を採用し、各テストレベルの責務を明確に分離しています。

#### テストレベルと責務

```
           E2E Tests (少数・高価値)
          /                      \
     Feature Tests (適量・統合検証)
    /                              \
Unit Tests (多数・高速・詳細)
```

| テストレベル | 主要責務 | 検証対象 | 実行環境 |
|-------------|---------|----------|---------|
| **Unit Tests** | 個別コンポーネントのロジック | バリデーション、計算処理、ビジネスロジック | モック・スタブ使用 |
| **Feature Tests** | API統合・データフロー | HTTPエンドポイント、データベース連携、リクエスト/レスポンス | 実際のHTTP + DB |
| **E2E Tests** | ユーザージャーニー | 画面操作、ページ遷移、ワークフロー | ブラウザ自動化 |

#### 重複の排除原則

- **APIの詳細検証**: Feature Testで実施、E2Eでは行わない
- **エラーハンドリング**: レベルごとに異なる観点で検証
  - Unit: ロジックレベルのエラー
  - Feature: HTTPレベルのエラー
  - E2E: ユーザー体験レベルのエラー
- **レスポンス構造**: Feature Testで詳細検証、E2Eでは最小限

#### E2Eテストの基本方針

E2Eテストは**ユーザーの実際の操作フロー**に特化し、APIの詳細検証は行いません：

- ✅ 画面遷移の確認
- ✅ UI操作の動作確認
- ✅ エンドツーエンドのワークフロー検証
- ❌ APIレスポンスの詳細構造検証
- ❌ 単体機能の詳細テスト

この方針により、**テスト実行速度の向上**、**保守コストの削減**、**安定性の向上**を実現しています。

#### E2Eテストの実装詳細

E2Eテストには**Playwright**を使用し、実際のブラウザでユーザーの操作フローを検証します：

**📁 テストファイル構成**
詳細な構成は [tests/e2e/](../../tests/e2e/) を参照してください。

**🎯 E2Eテストの焦点**
- ✅ ページの基本表示（React アプリケーションのマウント）
- ✅ ナビゲーション要素の存在確認
- ✅ レスポンシブデザインの動作確認
- ✅ JavaScriptエラーの検出
- ✅ アプリケーション状態管理の確認

**🚀 E2Eテスト実行方法**
```bash
# 基本実行
npx playwright test

# ヘッドレスモードで実行（ブラウザ画面表示）
npx playwright test --headed

# 特定のテストのみ実行
npx playwright test tests/e2e/homepage.spec.ts

# テストレポート表示
npx playwright show-report
```

**⚡ 実行パフォーマンス**
- 実行時間: 約2分（7テスト）
- 並列実行: 4ワーカーで同時実行
- 対象ブラウザ: Chrome（Chromium）
- CI環境: PostgreSQL + Laravel開発サーバー
- MCP統合: Claude Codeでテスト自動化サポート

## 品質チェック

### ✅ 自動実行される品質チェック（CI/CD）

**PR作成時に並列自動実行されます：**

**メインCIワークフロー（test.yml）:**
- PHPUnitテスト（429テスト）
- フロントエンドテスト（158テスト、vitest）
- Laravel Pintコードスタイルチェック
- PHPStan静的解析（レベル4、警告ゼロ）
- フロントエンドビルドテスト
- スクレイピングサービステスト
- **環境**: SQLite in-memory（高速・一貫性保証）
- **実行時間**: 約2分

**E2E専用CIワークフロー（e2e.yml）:**
- E2Eテスト（7テスト、Playwright）
- PostgreSQLデータベース使用
- 4並列実行で高速化
- Laravel開発サーバー起動
- **環境**: PostgreSQL + ブラウザ自動化
- **実行時間**: 約2分
- **MCP統合**: Claude Code連携でテスト自動化

**並列実行のメリット**:
- トータル実行時間: 約2分（並列実行で高速化）
- テスト責務分離: ユニット・Featureテスト vs E2Eテスト
- 環境分離: SQLite vs PostgreSQL
- CI統一化: ubuntu-latest + shivammathur/setup-php@v2

### 開発中の手動チェック（推奨）

開発中に以下を実行することで、CI/CDでのエラーを事前に防げます：

1. **バックエンドテスト実行**
   ```bash
   php artisan test
   ```

2. **フロントエンドテスト実行**
   ```bash
   npm test
   ```

3. **コードスタイルチェック**
   ```bash
   vendor/bin/pint --test  # チェックのみ
   vendor/bin/pint         # 自動修正
   ```

4. **静的解析**
   ```bash
   vendor/bin/phpstan analyse --memory-limit=1G
   ```

5. **フロントエンドビルド**
   ```bash
   npm run build
   ```

6. **E2Eテスト実行**
   ```bash
   npx playwright test
   
   # ヘッドレスモードで実行（ブラウザ画面表示）
   npx playwright test --headed
   
   # テストレポート表示
   npx playwright show-report
   
   # デバッグモードで実行
   npx playwright test --debug
   
   # UIモードで実行
   npx playwright test --ui
   ```

### テストでの日本語化Fakerの使用

テストでは日本語のダミーデータを生成するため、Fakerの日本語化を行っています。

実装の詳細は [tests/TestCase.php](../../tests/TestCase.php) を参照してください。

4. **スクレイピング機能テスト**
   ```bash
   # キューワーカーの起動確認
   php artisan queue:work --once
   
   # スクレイピングJobの手動実行
   php artisan tinker
   dispatch(new App\Jobs\HatenaScrapingJob());
   
   # Horizonでキューの状況確認
   php artisan horizon:status
   ```

## レビュー観点

### コードレビューで確認すべき点

- 機能要件の実現
- テストの妥当性
- コードスタイルの統一
- パフォーマンスの考慮
- セキュリティの確保
- 可読性・保守性
- **モデル関連の追加確認項目**
  - Migrationとモデルの整合性
  - 適切なfillable属性の設定
  - 型キャストの妥当性
  - テストカバレッジの十分性
  - 制約とバリデーションの適切性
- **スクレイピング関連の追加確認項目**
  - エラーハンドリングの実装
  - リトライ機能の設定
  - レート制限の考慮
  - 外部サイトの利用規約遵守
  - CompanyMatcherの適切な統合
  - 企業マッチング精度の検証

## wikiドキュメント更新の指示

### 更新タイミング
以下のような変更を行った際は、対応するwikiドキュメントの更新も検討してください：

#### 技術的変更
- 新しいライブラリ・パッケージ追加 → [技術スタック.md](技術スタック.md)
- 開発コマンド・環境設定変更 → [開発環境.md](開発環境.md)
- CI/CDワークフロー変更 → [CI-CD.md](CI-CD.md)

#### データベース変更
- migration追加・変更 → [データベース設計.md](データベース設計.md)
- モデル追加・変更 → [データベース設計.md](データベース設計.md)

#### 機能変更
- 新機能追加 → [機能仕様.md](機能仕様.md)
- 既存機能の大幅変更 → [機能仕様.md](機能仕様.md)

### 確認方法
変更後は以下を確認：
1. 実装とwikiドキュメントの内容に矛盾がないか
2. 新しい設定やコマンドがドキュメントに記載されているか
3. 古い情報が残っていないか

## 関連ドキュメント

- [開発環境](開発環境)
- [CI/CD](CI-CD)
- [技術スタック](技術スタック)
- [プロジェクト概要](プロジェクト概要)