# 開発フロー

## 開発原則

### DRY原則の適用

**ドキュメント**：
- 定義や説明の重複を避け、1つのドキュメントに集約
- 本ドキュメントに以下の内容を集約：
  - **テスト実行手順**: 全テストフレームワークの実行方法
  - **品質チェック**: コードスタイル・静的解析の手順
  - **Claude Codeカスタムコマンド**: 開発効率化ツールの詳細

**コーディング**：
- **コードの重複を避ける**: 同じ処理を複数箇所で実装しない
- **共通ロジックの抽象化**: 共通処理は適切にクラス・関数に抽象化
- **再利用性の重視**: 汎用的な処理は共通化して再利用

他のドキュメントから重複する記述を削除し、本ドキュメントへの参照に統一しています。

## 基本的な開発フロー

### 1. ブランチの作成

開発はブランチを切って作業する

```bash
# 新しいブランチを作成
git checkout -b feature/new-feature

# または
git switch -c feature/new-feature
```

### 2. 開発作業

- コードの実装
- **テストの作成・実行（必須）**
  - **Unit Tests**: ビジネスロジック・計算処理・バリデーション
  - **Feature Tests**: API統合・HTTPエンドポイント・データベース連携
  - **E2E Tests**: 新しいページ・機能に対するユーザージャーニー検証（**新機能実装時は必須**）
- コードスタイルチェック
- 静的解析の実行

#### モデル作成時の必須要件

新しいモデル作成時は以下を含める：
1. **Migration**: テーブル構造・インデックス・制約・コメント
2. **モデルクラス**: fillable属性・型キャスト・デフォルト値・リレーション
3. **ユニットテスト**: 基本作成・バリデーション・制約・型変換・リレーション

### 3. プルリクエストの作成

- 必ずプルリクエストを作成
- 適切なタイトルと説明を記述
- レビュアーを指定

### 4. コードレビュー

- 必ずプルリクエストのレビューを通す
- レビューでの指摘は修正する
- 承認後にmergeの準備が完了

### 5. マージ

- その後GitHub上でmergeを行う
- マージ後はローカルブランチを削除

## ブランチ命名規則

### 推奨命名パターン

```
feature/機能名      # 新機能追加
bugfix/バグ修正名   # バグ修正
hotfix/緊急修正名   # 緊急修正
refactor/リファクタ名 # リファクタリング
```

### 例

```
feature/user-authentication
bugfix/login-error
hotfix/security-patch
refactor/database-queries
```

## コミットメッセージ

### フォーマット

```
種類: 概要

詳細説明（必要に応じて）
```

### 種類の例

- `feat`: 新機能追加
- `fix`: バグ修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `docs`: ドキュメント更新

## テスト戦略

**詳細**: [テスト戦略](テスト戦略.md)を参照

### テスト実装の基本原則
- **新機能実装時**: 対応するテストを必ず作成し、既存のカバレッジレベルを維持または向上させる
- **E2Eテスト必須**: 新しいページや機能には必ずE2Eテストを実装する
- **カバレッジ維持**: 90%以上のテストカバレッジを必ず維持する


## テスト・品質チェック

### テスト実行コマンド

#### 開発作業中の必須実行コマンド

開発中は以下を定期的に実行してCIエラーを事前に防ぐ：

```bash
# PHPUnit テスト実行
php artisan test

# テストカバレッジ確認
php artisan test --coverage-html=coverage-html
# 注意: カバレッジレポートは必ず coverage-html ディレクトリに出力してください

# コードスタイルチェック（自動修正）
vendor/bin/pint

# 静的解析
vendor/bin/phpstan analyse --memory-limit=1G

# フロントエンドテスト実行
npm test

# フロントエンドビルド
npm run build

# E2Eテスト実行
npx playwright test
```

#### PR作成前の必須チェック

**すべて実行し、エラーがないことを確認する：**

```bash
# 包括的品質チェック（一括実行）
php artisan test && vendor/bin/pint --test && vendor/bin/phpstan analyse --memory-limit=1G && npm test && npm run build && npm run test:e2e
```

**⚠️ メモリ制限について:**
- **PHPUnit**: `phpunit.xml`で512Mに設定済み（メモリ不足エラー対策）
- **PHPStan**: `--memory-limit=1G`オプション必須
- 大量テスト実行時のメモリ不足を防止

**⚠️ 新機能実装時の追加チェック：**
- **新しいページ・機能のE2Eテストが実装されていることを確認**
- E2Eテストが正常に実行されることを確認
- E2Eテストが適切なユーザージャーニーをカバーしていることを確認

#### 個別テスト実行

**PHPUnitテスト:**
```bash
# 全テスト実行
php artisan test

# 特定のテスト実行
php artisan test --filter TestName

# 特定のテストファイル実行
php artisan test tests/Unit/ModelTest.php
```

**コードスタイルチェック:**
```bash
# スタイルチェック（自動修正）
vendor/bin/pint

# ドライラン（確認のみ）
vendor/bin/pint --test
```

**静的解析:**
```bash
# 静的解析実行
vendor/bin/phpstan analyse --memory-limit=1G
```

**フロントエンドテスト:**
```bash
# フロントエンドテスト実行
npm test

# フロントエンドビルド
npm run build
```

**E2Eテスト:**
```bash
# E2Eテスト実行
npm run test:e2e

# E2Eテストレポート表示
npx playwright show-report

# E2Eテストをヘッドレスモードで実行
npm run test:e2e:headed

# デバッグモードで実行
npm run test:e2e:debug

# UIモードで実行
npm run test:e2e:ui

# 特定のテストファイルのみ実行
npx playwright test tests/e2e/homepage.spec.ts
```

### ✅ 自動実行される品質チェック（CI/CD）

**PR作成時に並列自動実行されます：**

**品質チェックワークフロー（test.yml）:**
- PHPUnitテスト（667テスト）
- フロントエンドテスト（189テスト、vitest）
- Laravel Pintコードスタイルチェック
- PHPStan静的解析（レベル4、警告ゼロ）
- フロントエンドビルドテスト
- スクレイピングサービステスト
- **環境**: SQLite in-memory（高速・一貫性保証）
- **実行時間**: 約2分

**E2E専用CIワークフロー（e2e.yml）:**
- E2Eテスト（13テスト、Playwright）
- PostgreSQLデータベース使用
- 4並列実行で高速化
- Laravel開発サーバー起動
- **環境**: PostgreSQL + ブラウザ自動化
- **実行時間**: 約2分
- **MCP統合**: Claude Code連携でテスト自動化

**並列実行のメリット**:
- トータル実行時間: 約2分（並列実行で高速化）
- テスト責務分離: ユニット・Featureテスト vs E2Eテスト
- 環境分離: SQLite vs PostgreSQL
- CI統一化: ubuntu-latest + shivammathur/setup-php@v2

### 開発中の手動チェック（推奨）

開発中に以下を実行することで、CI/CDでのエラーを事前に防げます：

1. **バックエンドテスト実行**
   ```bash
   php artisan test
   ```

2. **フロントエンドテスト実行**
   ```bash
   npm test
   ```

3. **コードスタイルチェック**
   ```bash
   vendor/bin/pint --test  # チェックのみ
   vendor/bin/pint         # 自動修正
   ```

4. **静的解析**
   ```bash
   vendor/bin/phpstan analyse --memory-limit=1G
   ```

5. **フロントエンドビルド**
   ```bash
   npm run build
   ```

6. **E2Eテスト実行**
   ```bash
   npx playwright test
   
   # ヘッドレスモードで実行（ブラウザ画面表示）
   npx playwright test --headed
   
   # テストレポート表示
   npx playwright show-report
   
   # デバッグモードで実行
   npx playwright test --debug
   
   # UIモードで実行
   npx playwright test --ui
   ```

### テストでの日本語化Fakerの使用

テストでは日本語のダミーデータを生成するため、Fakerの日本語化を行っています。

実装の詳細は [tests/TestCase.php](../../tests/TestCase.php) を参照してください。

4. **スクレイピング機能テスト**
   ```bash
   # キューワーカーの起動確認
   php artisan queue:work --once
   
   # スクレイピングJobの手動実行
   php artisan tinker
   dispatch(new App\Jobs\HatenaScrapingJob());
   
   # Horizonでキューの状況確認
   php artisan horizon:status
   ```

## レビュー観点

### コードレビューで確認すべき点

- 機能要件の実現
- テストの妥当性
- コードスタイルの統一
- パフォーマンスの考慮
- セキュリティの確保
- 可読性・保守性
- **E2Eテスト実装の確認**
  - 新しいページ・機能にE2Eテストが実装されているか
  - E2Eテストが適切なユーザージャーニーをカバーしているか
  - レスポンシブデザイン・エラー処理の検証が含まれているか
- **モデル関連の追加確認項目**
  - Migrationとモデルの整合性
  - 適切なfillable属性の設定
  - 型キャストの妥当性
  - テストカバレッジの十分性（95%以上維持）
  - 制約とバリデーションの適切性
- **スクレイピング関連の追加確認項目**
  - エラーハンドリングの実装
  - リトライ機能の設定
  - レート制限の考慮
  - 外部サイトの利用規約遵守
  - CompanyMatcherの適切な統合
  - 企業マッチング精度の検証

## wikiドキュメント更新の指示

### 更新タイミング
以下のような変更を行った際は、対応するwikiドキュメントの更新も検討してください：

#### 技術的変更
- 新しいライブラリ・パッケージ追加 → [技術スタック.md](技術スタック.md)
- 開発コマンド・環境設定変更 → [開発環境.md](開発環境.md)
- CI/CDワークフロー変更 → [CI-CD.md](CI-CD.md)

#### データベース変更
- migration追加・変更 → [データベース設計.md](データベース設計.md)
- モデル追加・変更 → [データベース設計.md](データベース設計.md)

#### 機能変更
- 新機能追加 → [機能仕様.md](機能仕様.md)
- 既存機能の大幅変更 → [機能仕様.md](機能仕様.md)

### 確認方法
変更後は以下を確認：
1. 実装とwikiドキュメントの内容に矛盾がないか
2. 新しい設定やコマンドがドキュメントに記載されているか
3. 古い情報が残っていないか

## Claude Codeカスタムコマンド

### 利用可能なコマンド
- `/think` - 開発方針の検討・技術調査
- `/dev` - 開発実行（Issue管理・実装・品質チェック）
- `/test` - 包括的品質チェック
- `/pr` - プルリクエスト作成フロー

**特徴**: Issue管理統合、段階的品質チェック、ドキュメント連携、CI/CD統合

## 関連ドキュメント

- [テスト戦略](テスト戦略.md) - テスト実装の詳細
- [CI/CD](CI-CD.md) - 自動化パイプライン